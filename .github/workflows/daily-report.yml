name: æ¯æ—¥æ•°æ®æœé›†æŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 (UTC) è¿è¡Œï¼Œç›¸å½“äºŽåŒ—äº¬æ—¶é—´ 16:00
    - cron: '0 8 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  PYTHON_VERSION: '3.10'

jobs:
  data-collection:
    name: æ•°æ®æœé›†
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4 pandas numpy

      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p scrapers/output

      - name: è¿è¡Œ Instagram ç«žå“æ•°æ®æœé›†
        run: |
          python scrapers/instagram.py

      - name: è¿è¡Œæ–°é—»æ•°æ®æœé›†
        run: |
          python scrapers/news.py

      - name: è¿è¡Œè¶‹åŠ¿æ•°æ®æœé›†
        run: |
          python scrapers/trends.py

      - name: ä¸Šä¼ æœé›†çš„æ•°æ®
        uses: actions/upload-artifact@v3
        with:
          name: daily-data-${{ github.event_name }}
          path: scrapers/output/
          retention-days: 30

  analysis:
    name: æ•°æ®åˆ†æž
    needs: data-collection
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4 pandas numpy

      - name: ä¸‹è½½æœé›†çš„æ•°æ®
        uses: actions/download-artifact@v3
        with:
          name: daily-data-${{ github.event_name }}

      - name: è¿è¡Œæ•°æ®åˆ†æž
        run: |
          python analysis/daily_analysis.py

      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          python reports/generate_report.py

      - name: ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: daily-report-${{ github.event_name }}
          path: reports/output/
          retention-days: 90

  notification:
    name: å‘é€é€šçŸ¥
    needs: analysis
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»º GitHub Issue è®°å½•
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const reportUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            const title = `ðŸ“Š æ¯æ—¥æ•°æ®æŠ¥å‘Š - ${today}`;

            const body = `## æ•°æ®æœé›†æ‘˜è¦

            âœ… **æ•°æ®æœé›†å®Œæˆ**
            - [x] Instagram ç«žå“æ•°æ®å·²æ›´æ–°
            - [x] è¡Œä¸šæ–°é—»å·²æœé›†
            - [x] è¶‹åŠ¿åˆ†æžå·²å®Œæˆ

            ## æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š

            ðŸ“Š [GitHub Actions Artifacts](${reportUrl}/artifacts)
            ðŸ” [ä»“åº“é¡µé¢](https://github.com/${{ github.repository }})

            ## æ•°æ®æ–‡ä»¶

            ### Instagram ç«žå“æ•°æ®
            - @heathceramics (çŽ°ä»£å»ºç­‘é™¶ç“·)
            - @keramicstudio (æ¸©æš–æ‰‹ä½œé™¶ç“·)
            - @juliettemcinty (è‡ªç„¶æœ‰æœºé™¶ç“·)
            - @thecupcollection (æ¯å…·ä¸“é—¨åº—)

            ### æ–°é—»æ•°æ®
            - Ceramic Arts Network
            - Ceramic Monthly
            - Etsy Seller Handbook

            ### è¶‹åŠ¿æ•°æ®
            - handmade ceramics
            - pottery art
            - tea ceremony
            - ceramic home decor

            ## éœ€è¦å…³æ³¨

            - æ–°å‘çŽ°çš„ç«žå“æ´»åŠ¨
            - çƒ­é—¨å†…å®¹çš„å‘å¸ƒé¢‘çŽ‡
            - è¶‹åŠ¿å…³é”®è¯çš„å˜åŒ–

            ---

            *æœ¬æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
            *ç”Ÿæˆæ—¶é—´: ${today}*
            *è¿è¡ŒID: ${{ github.run_id }}*
            `;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-report', 'automated']
            }).catch(error => {
              console.error('åˆ›å»º Issue å¤±è´¥:', error);
            });
