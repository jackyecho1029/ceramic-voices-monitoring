name: æ¯æ—¥æ•°æ®æœé›†æŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 8:00 (UTC) è¿è¡Œï¼Œç›¸å½“äºåŒ—äº¬æ—¶é—´ 16:00
    - cron: '0 8 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  data-collection:
    name: æ•°æ®æœé›†
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4 pandas numpy

      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p scrapers/output

      - name: è¿è¡Œæ–°é—»æ•°æ®æœé›†
        run: |
          python scrapers/news.py

      - name: è¿è¡Œè¶‹åŠ¿æ•°æ®æœé›†
        run: |
          python scrapers/trends.py

      - name: ä¸Šä¼ æœé›†çš„æ•°æ®
        uses: actions/upload-artifact@v3
        with:
          name: daily-data-${{ github.event_name }}
          path: scrapers/output/
          retention-days: 30

  analysis:
    name: æ•°æ®åˆ†æ
    needs: data-collection
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install requests beautifulsoup4 pandas numpy

      - name: ä¸‹è½½æœé›†çš„æ•°æ®
        uses: actions/download-artifact@v3
        with:
          name: daily-data-${{ github.event_name }}

      - name: è¿è¡Œæ•°æ®åˆ†æ
        run: |
          python analysis/daily_analysis.py

      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          python reports/generate_report.py

      - name: ä¸Šä¼ æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: daily-report-${{ github.event_name }}
          path: reports/output/
          retention-days: 90

  notification:
    name: å‘é€é€šçŸ¥
    needs: analysis
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: åˆ›å»º GitHub Issue è®°å½•
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const title = `ğŸ“Š æ¯æ—¥æ•°æ®æŠ¥å‘Š - ${{today }}`;

            const body = `## æ•°æ®æœé›†æ‘˜è¦
            - [ ] Instagram ç«å“æ•°æ®å·²æ›´æ–°
            - [ ] è¡Œä¸šæ–°é—»å·²æœé›†
            - [ ] è¶‹åŠ¿åˆ†æå·²å®Œæˆ

            ## éœ€è¦å…³æ³¨
            ...

            ## æ•°æ®æ–‡ä»¶
            è¯·æŸ¥çœ‹ Artifacts è·å–è¯¦ç»†æ•°æ®ã€‚`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['daily-report']
            });
